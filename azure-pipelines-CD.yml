pool:
  name: local

trigger:
  - develop
  - release
  - master

variables:
  - ${{ if eq(variables['Build.SourceBranchName'], 'develop') }}:
    - name: environment
      value: dev
  - ${{ if eq(variables['Build.SourceBranchName'], 'release') }}:
    - name: environment
      value: test
  - ${{ if eq(variables['Build.SourceBranchName'], 'master') }}:
    - name: environment
      value: prod

stages:
  - stage: docker
    displayName: "docker build and push ${{ variables.environment }}"
    jobs:
      - job: docker
        steps:
          - task: Docker@2
            displayName: "docker build and push"
            inputs:
              containerRegistry: 'dockerregistry'
              repository: 'dummy'
              command: 'buildAndPush'
              Dockerfile: 'Dockerfile'
              buildContext: '.'
  - stage: k8s
    dependsOn: docker
    displayName: "k8s deploy on ${{ variables.environment }}"
    jobs:
      - deployment:
        displayName: "operadores ${{ variables.environment }}"
        environment:
          name: $(environment)
        strategy:
          runOnce:
            deploy:
              steps:
                - script: echo "k8s deploy"
                  displayName: "deploy to k8s cluster"
                - script: echo "owasp test"
                  displayName: "test de owasp"
                  condition: or(eq(variables.environment, 'dev'),eq(variables.environment, 'test'))
  

